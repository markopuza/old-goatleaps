<html>
	<head>
		<title> Metaharmony </title>
		<style>
      body {
      				background-color: #000;
      				margin: 0;
      				overflow: hidden;
      			}

			canvas { width: 100%; height: 100% }

      .label{
				color: #000000;
				font-family: sans-serif;
				font-size: 1.7em;
				margin-left: 0.7em;
				padding: 0.7em;
			}

			.label{
				color: #000000;
				font-family: sans-serif;
			}
		</style>
	</head>
	<body>
		<script src="script/three.min.js"></script>
		<script src="script/dat.gui.min.js"></script>
    <script src="script/orbit_controls.js"></script>
    <script src="script/threejslabelrenderer.js"></script>
		<script>
      /***********************
        Global parameters
      ************************/
      var enabled_controls = true;

      /***********************
        Colors
      ************************/
      var blue = 0x0eb6ff;
      var purple = 0xed1df3;
      var red = 0xf81f4a;
      var orange = 0xff9f1c;
      var yellow = 0xfafa18;
      var green = 0x6be412;

      /***********************
        Bearings
      ************************/
      var north = [0,1];
      var east = [1,0];
      var south = [0,-1];
      var west = [-1,0];

      /***********************
        Setting up graphics for Three.js
      ************************/
      var scene = new THREE.Scene();
      scene.background = new THREE.Color( 0xeeeeee );

			var camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 1000 );

			var renderer = new THREE.WebGLRenderer();
			renderer.setSize( window.innerWidth, window.innerHeight );
			document.body.appendChild( renderer.domElement );

      var labelRenderer = new THREE.CSS2DRenderer();
        labelRenderer.setSize( window.innerWidth, window.innerHeight );
        labelRenderer.domElement.style.position = 'absolute';
        labelRenderer.domElement.style.top = 0;
        document.body.appendChild( labelRenderer.domElement );

			if (enabled_controls) {
				var controls = new THREE.OrbitControls( camera );
			}

      /***********************
        Initial settings for the scene
      ************************/
      scene.updateMatrixWorld(true);

      camera.position.z = 4;

      renderer.render( scene, camera );
      labelRenderer.render( scene, camera );

      /***********************
        Function for clearing the scene
      ************************/
      function clearScene() {
        for (var i = scene.children.length - 1; i >= 0; i--) {
          var ch = scene.children[i];
          scene.remove(ch);
          for (var j = ch.children.length - 1; j >= 0; j--) {
            cch = ch.children[j];
            for (var k = cch.children.length - 1; k >= 0; k--) {
              cch.remove(cch.children[k]);
            }
            ch.remove(cch);
            cch.geometry.dispose();
            cch.material.dispose();
            cch = undefined;
          }
          ch = undefined;
        }
      }

      /***********************
        Function for adding an edge between two points
      ************************/
      function addEdge(from, to, color) { // from, to are Vectors
				var vector = to.sub(from);
				var group = new THREE.Group();

				var geometry = new THREE.CylinderGeometry(0.06, 0.06, vector.length(), 12, 12);
				var meshMaterial = new THREE.MeshBasicMaterial( {color: color, morphTargets: true} );
				var lineMaterial = new THREE.LineBasicMaterial( { color: 0x222222, transparent: true, opacity: 0.1 } );

				var mesh = new THREE.Mesh(geometry, meshMaterial);
				var frame = new THREE.LineSegments(geometry, lineMaterial);

				var axis = new THREE.Vector3(0, 1, 0);
				mesh.quaternion.setFromUnitVectors(axis, vector.clone().normalize());
				frame.quaternion.setFromUnitVectors(axis, vector.clone().normalize());

				var edgeCenter = from.add(vector.multiplyScalar(0.5));
				mesh.position.set(edgeCenter.x, edgeCenter.y, edgeCenter.z);
				frame.position.set(edgeCenter.x, edgeCenter.y, edgeCenter.z);

				group.add(mesh);
				group.add(frame);

				scene.add( group );
			}

      /***********************
        Function for adding a vertex
      ************************/
      function addVertex(pos, name, color) {
        var group = new THREE.Group();

				var geometry = new THREE.DodecahedronGeometry( 0.06 );
				var meshMaterial = new THREE.MeshBasicMaterial( {color: color} );
				var sphere = new THREE.Mesh( geometry, meshMaterial );
				sphere.position.set(pos.x, pos.y, pos.z);

				var noteDiv = document.createElement( 'div' );
				noteDiv.className = 'label';
				noteDiv.textContent = name.split(' ')[0];
				noteDiv.style.marginTop = '-25px';
				noteDiv.style.zIndex = 2;

				var noteLabel = new THREE.CSS2DObject( noteDiv );
				sphere.add( noteLabel );

				group.add( sphere );
        scene.add( group );
			}


      /**********************************************************
        METAPRISM
      **********************************************************/
      var METAPRISM = {
        initial_notes: {
          /*format is
          "note label":[x,y,z,w, colour, bearing, point index]
              where
          "note label"="note name  note index"*/

          /*fifth cycle 1*/
          "F 1": [1,-1,Math.sqrt(3),-1,1, blue, west, 0],
          "C 1": [1,-1,Math.sqrt(3),1,1, yellow, north, 1],
          "G 1": [-1, -1,Math.sqrt(3),1,1, red, east, 2],
          "D 1": [-1,-1,Math.sqrt(3),-1,1, blue, south, 3],
          "A 1": [-2,-1,0,-1,1, yellow, west, 4],
          "E 1": [-2,-1,0,1,1, red, north, 5],
          "B 1": [-1,-1,-Math.sqrt(3),1,1, blue, east, 6],
          "F#/Gb 1": [-1,-1,-Math.sqrt(3),-1,1, yellow, south, 7],
          "C#/Db 1": [1,-1,-Math.sqrt(3),-1,1, red, west, 8],
          "G#/Ab 1": [1,-1,-Math.sqrt(3),1,1, blue, north, 9],
          "D#/Eb 1": [2,-1,0,1,1, yellow, east, 10],
          "A#/Bb 1": [2,-1,0,-1,1, red, south, 11],

          /*fifth cycle 2*/
          "D 2": [1,1,Math.sqrt(3),-1,1, blue, north, 12],
          "A 2": [1,1,Math.sqrt(3),1,1, yellow, east, 13],
          "E 2": [-1,1,Math.sqrt(3),1,1, red, south, 14],
          "B 2": [-1,1,Math.sqrt(3),-1,1, blue, west, 15],
          "F#/Gb 2": [-2,1,0,-1,1, yellow, north, 16],
          "C#/Db 2": [-2,1,0,1,1, red, east, 17],
          "G#/Ab 2": [-1,1,-Math.sqrt(3),1,1, blue, south, 18],
          "D#/Eb 2": [-1,1,-Math.sqrt(3),-1,1, yellow, west, 19],
          "A#/Bb 2": [1,1,-Math.sqrt(3),-1,1, red, north, 20],
          "F 2": [1,1,-Math.sqrt(3),1,1,blue, east, 21],
          "C 2": [2,1,0,1,1, yellow, south, 22],
          "G 2": [2,1,0,-1,1, red, west, 23],

          /*fifth cycle 3*/
          "B 3": [1,1,Math.sqrt(3),-1,-1, blue, east, 24],
          "F#/Gb 3": [1,1,Math.sqrt(3),1,-1, yellow, south, 25],
          "C#/Db 3": [-1,1,Math.sqrt(3),1,-1, red, west, 26],
          "G#/Ab 3": [-1,1,Math.sqrt(3),-1,-1, blue, north, 27],
          "D#/Eb 3": [-2,1,0,-1,-1, yellow, east, 28],
          "A#/Bb 3": [-2,1,0,1,-1, red, south, 29],
          "F 3": [-1,1,-Math.sqrt(3),1,-1, blue, west, 30],
          "C 3": [-1,1,-Math.sqrt(3),-1,-1, yellow, north, 31],
          "G 3": [1,1,-Math.sqrt(3),-1,-1, red, east, 32],
          "D 3": [1,1,-Math.sqrt(3),1,-1, blue, south, 33],
          "A 3": [2,1,0,1,-1, yellow, west, 34],
          "E 3": [2,1,0,-1,-1, red, north, 35],

          /*fifth cycle 4*/
          "G#/Ab 4": [1,-1,Math.sqrt(3),-1,-1, blue, south, 36],
          "D#/Eb 4": [1,-1,Math.sqrt(3),1,-1, yellow, west, 37],
          "A#/Bb 4": [-1,-1,Math.sqrt(3),1,-1, red, north, 38],
          "F 4": [-1,-1,Math.sqrt(3),-1,-1, blue, east, 39],
          "C 4": [-2,-1,0,-1,-1, yellow, south, 40],
          "G 4": [-2,-1,0,1,-1, red, west, 41],
          "D 4": [-1,-1,-Math.sqrt(3),1,-1, blue, north, 42],
          "A 4": [-1,-1,-Math.sqrt(3),-1,-1, yellow, east, 43],
          "E 4": [1,-1,-Math.sqrt(3),-1,-1, red, south, 44],
          "B 4": [1,-1,-Math.sqrt(3),1,-1, blue, west, 45],
          "F#/Gb 4": [2,-1,0,1,-1, yellow, north, 46],
          "C#/Db 4": [2,-1,0,-1,-1, red, east, 47]
        },

        edges: [
          /*"vertical" edges of the tone column*/
          ["C 1", "G 1"], ["G 1", "D 1"], ["D 1", "A 1"], ["A 1", "E 1"], ["E 1", "B 1"], ["B 1", "F#/Gb 1"],  ["F#/Gb 1", "C#/Db 1"],
          ["C#/Db 1", "G#/Ab 1"], ["G#/Ab 1","D#/Eb 1"], ["G#/Ab 1","D#/Eb 1"], ["D#/Eb 1","A#/Bb 1"], ["A#/Bb 1", "F 1"], ["F 1", "C 1"],

          ["C 2", "G 2"], ["G 2", "D 2"], ["D 2", "A 2"], ["A 2", "E 2"], ["E 2", "B 2"], ["B 2", "F#/Gb 2"],  ["F#/Gb 2", "C#/Db 2"],
          ["C#/Db 2", "G#/Ab 2"], ["G#/Ab 2","D#/Eb 2"], ["G#/Ab 2","D#/Eb 2"], ["D#/Eb 2","A#/Bb 2"], ["A#/Bb 2", "F 2"], ["F 2", "C 2"],

          ["C 3", "G 3"], ["G 3", "D 3"], ["D 3", "A 3"], ["A 3", "E 3"], ["E 3", "B 3"], ["B 3", "F#/Gb 3"],  ["F#/Gb 3", "C#/Db 3"],
          ["C#/Db 3", "G#/Ab 3"], ["G#/Ab 3","D#/Eb 3"], ["G#/Ab 3","D#/Eb 3"], ["D#/Eb 3","A#/Bb 3"], ["A#/Bb 3", "F 3"], ["F 3", "C 3"],

          ["C 4", "G 4"], ["G 4", "D 4"], ["D 4", "A 4"], ["A 4", "E 4"], ["E 4", "B 4"], ["B 4", "F#/Gb 4"],  ["F#/Gb 4", "C#/Db 4"],
          ["C#/Db 4", "G#/Ab 4"], ["G#/Ab 4","D#/Eb 4"], ["G#/Ab 4","D#/Eb 4"], ["D#/Eb 4","A#/Bb 4"], ["A#/Bb 4", "F 4"], ["F 4", "C 4"],

          /*cornerstone edges*/

          ["F 1", "D 2"], ["D 2", "B 3"], ["B 3", "G#/Ab 4"], ["G#/Ab 4", "F 1"],
          ["F 2", "D 3"], ["D 3", "B 4"], ["B 4", "G#/Ab 1"], ["G#/Ab 1", "F 2"],
          ["F 3", "D 4"], ["D 4", "B 1"], ["B 1", "G#/Ab 2"], ["G#/Ab 2", "F 3"],
          ["F 4", "D 1"], ["D 1", "B 2"], ["B 2", "G#/Ab 3"], ["G#/Ab 3", "F 4"],

          ["C 1", "A 2"], ["A 2", "F#/Gb 3"], ["F#/Gb 3", "D#/Eb 4"], ["D#/Eb 4", "C 1"],
          ["C 2", "A 3"], ["A 3", "F#/Gb 4"], ["F#/Gb 4", "D#/Eb 1"], ["D#/Eb 1", "C 2"],
          ["C 3", "A 4"], ["A 4", "F#/Gb 1"], ["F#/Gb 1", "D#/Eb 2"], ["D#/Eb 2", "C 3"],
          ["C 4", "A 1"], ["A 1", "F#/Gb 2"], ["F#/Gb 2", "D#/Eb 3"], ["D#/Eb 3", "C 4"],

          ["G 1", "E 2"], ["E 2", "C#/Db 3"], ["C#/Db 3", "A#/Bb 4"], ["A#/Bb 4", "G 1"],
          ["G 2", "E 3"], ["E 3", "C#/Db 4"], ["C#/Db 4", "A#/Bb 1"], ["A#/Bb 1", "G 2"],
          ["G 3", "E 4"], ["E 4", "C#/Db 1"], ["C#/Db 1", "A#/Bb 2"], ["A#/Bb 2", "G 3"],
          ["G 4", "E 1"], ["E 1", "C#/Db 2"], ["C#/Db 2", "A#/Bb 3"], ["A#/Bb 3", "G 4"],

          /*edges of diminished cubes which are not edges of cornerstones*/

          ["F 1", "D 1"], ["D 2", "B 2"], ["B 3", "G#/Ab 3"], ["G#/Ab 4", "F 4"],
          ["G 1", "E 1"], ["E 2", "C#/Db 2"], ["C#/Db 3", "A#/Bb 3"], ["A#/Bb 4", "G 4"],
          ["A 1", "F#/Gb 1"], ["F#/Gb 2", "D#/Eb 2"], ["D#/Eb 3", "C 3"], ["C 4", "A 4"],
          ["B 1", "G#/Ab 1"], ["G#/Ab 2", "F 2"], ["F 3", "D 3"], ["D 4", "B 4"],
          ["C#/Db 1", "A#/Bb 1"], ["A#/Bb 2", "G 2"], ["G 3", "E 3"], ["E 4", "C#/Db 4"],
          ["D#/Eb 1", "C 1"], ["C 2", "A 2"], ["A 3", "F#/Gb 3"], ["F#/Gb 4", "D#/Eb 4"]
        ],

        subsets: {

          /*CORNERSTONES*/
					cornerstones: {
		          "b1": [0,12,24,36],	/*blue cornerstone 2.1*/
		          "b2": [3,15,27,39],	/*blue cornerstone 2.2*/
		          "b3": [6,18,30,42],	/*blue cornerstone 1.1*/
		          "b4": [9,21,33,45],	/*blue cornerstone 1.2*/

		          "y1": [1,13,25,37],	/*yellow cornerstone 1.2*/
		          "y2": [4,16,28,40],	/*yellow cornerstone 2.1*/
		          "y3": [7,19,31,43],	/*yellow cornerstone 2.2*/
		          "y4": [10,22,34,46],	/*yellow cornerstone 1.1*/

		          "r1": [2,14,26,38],	/*red cornerstone 1.1*/
		          "r2": [5,17,29,41],	/*red cornerstone 1.2*/
		          "r3": [8,20,32,44],	/*red cornerstone 2.1*/
		          "r4": [11,23,35,47]	/*red cornerstone 2.2*/
						},

          /*FIFTH CYCLES*/

					fifth_cycles: {
	          "1": [0,1,2,3,4,5,6,7,8,9,10,11],                           /*fifth cycle 1*/
	          "2": [12,13,14,15,16,17,18,19,20,21,22,23],       /*fifth cycle 2*/
	          "3": [24,25,26,27,28,29,30,31,32,33,34,35],       /*fifth cycle 3*/
	          "4": [36,37,38,39,40,41,42,43,44,45,46,47]	 /*fifth cycle 4*/
					},

          /*ARCADIA*/
					arcadia: {
          	"1": [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],                           /*longitudinal arcade 1, union of fifth cycles 1 and 2 */
          	"2": [12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35],       /*latitudinal arcade 1, union of fifth cycles 2 and 3*/
          	"3": [24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47],       /*longitudinal arcade 2, union of fifth cycles 3 and 4 */
          	"4": [36,37,38,39,40,41,42,43,44,45,46,47,0,1,2,3,4,5,6,7,8,9,10,11]                            /*latitudinal arcade 2, union of fifth cycles 4 and 1 */
					},

          /*ALPHA CUBES*/
          /*tonic and dominant 1’s and 2’s are respectively tonic and dominant alphas of hypercubes 1 and 2*/
					alpha_cubes: {
	          "green1": [0,12,24,36,1,13,25,37],		/*green alpha, dominant 2*/
	          "orange1": [1,13,25,37,2,14,26,38],		/*orange alpha, tonic 1*/
	          "purple1": [2,14,26,38,3,15,27,39],		/*purple alpha, dominant 1*/
	          "green2": [3,15,27,39,4,16,28,40],		/*green alpha, tonic 2*/
	          "orange2": [4,16,28,40,5,17,29,41],		/*orange alpha, dominant 2*/
	          "purple2": [5,17,29,41,6,18,30,42],		/*purple alpha, tonic 1*/
	          "green3": [6,18,30,42,7,19,31,43],		/*green alpha, dominant  1*/
	          "orange3": [7,19,31,43,8,20,32,44],		/*orange alpha, tonic 2*/
	          "purple3": [8,20,32,44,9,21,33,45],		/*purple alpha, dominant 2*/
	          "green4": [9,21,33,45,10,22,34,46],		/*green alpha, tonic 1*/
	          "orange4": [10,22,34,46,11,23,35,47],		/*orange alpha, dominant 1*/
	          "purple4": [11,23,35,47,0,12,24,36]		/*purple alpha, tonic 2*/
					},

          /*DIMINISHED CUBES*/
					diminished_cubes: {
		         "blue1": [0,12,24,36,3,15,27,39],		/*blue diminished 2, union of blue cornerstones 2.1 and 2.2*/
		         "yellow1": [4,16,28,40,7,19,31,43],		/*yellow diminished 2, union of union of yellow cornerstones 2.1 and 2.2*/
		         "red1": [8,20,32,44,11,23,35,47],		/*red diminished 2, union of red cornerstones 2.1 and 2.2*/
		         "blue2": [6,18,30,42,9,21,33,45],		/*blue diminished 1, union of blue cornerstones 1.1 and 1.2*/
		         "yellow2": [10,22,34,46,1,13,25,37],		/*yellow diminished 1, union of yellow cornerstones 1.1 and 1.2*/
		         "red2": [2,14,26,38, 5,17,29,41]		/*red diminished 1, union of red cornerstones 1.1 and 1.2*/
						},

          /*ATRIA*/
					atria: {
	          "2": [0,12,24,36,3,15,27,39,4,16,28,40,7,19,31,43,8,20,32,44,11,23,35,47],             /*atrium 2, union of blue, yellow and red diminished 2’s*/
	          "1": [6,18,30,42,9,21,33,45,10,22,34,46,1,13,25,37,2,14,26,38, 5,17,29,41]           /*atrium 1, union of blue, yellow and red diminished 1’s*/
					},

          /*HYPERCUBES*/
					hypercubes: {
		          "orange1": [0,1,2,3,12,13,14,15,24,25,26,27,36,37,38,39],   /*orange hypercube 1, tonic alpha is in atrium 1*/
		          "orange1_key1": [0,1,2,3,12,13,14,15],              	 /*C Key cube 1*/
		          "orange1_key2": [12,13,14,15,24,25,26,27],		 /*A Key cube 1*/
		          "orange1_key3": [24,25,26,27,36,37,38,39],		 /*F#/Gb Key cube 1*/
		          "orange1_key4": [36,37,38,39,0,1,2,3],			 /*D#/Eb Key cube 1*/

		          "green1": [2,3,4,5,14,15,16,17,26,27,28,29,38,39,40,41], /*green hypercube 1, tonic alpha is in atrium 1*/
		          "green1_key1":[2,3,4,5,14,15,16,17],			/*D Key cube 1*/
		          "green1_key2":[14,15,16,17,26,27,28,29],		/*B Key cube 1*/
		          "green1_key3":[26,27,28,29,38,39,40,41],		/*G#/Ab Key cube 1*/
		          "green1_key4": [38,39,40,41,2,3,4,5],		/*F Key cube 1*/

		          "purple1": [4,5,6,7,16,17,18,19,28,29,30,31,40,41,42,43],  /*purple hypercube 1, tonic alpha is in atrium 1*/
		          "purple1_key1": [4,5,6,7,16,17,18,19],		/*E Key cube*/
		          "purple1_key2": [16,17,18,19,28,29,30,31],		/*C#/Db Key cube*/
		          "purple1_key3": [28,29,30,31,40,41,42,43],		/*A#/Bb Key cube*/
		          "purple1_key4": [40,41,42,43,4,5,6,7],			/*G Key cube*/

		          "orange2": [6,7,8,9,18,19,20,21,30,31,32,33,42,43,44,45],   /*orange hypercube 2, tonic alpha is in atrium 2*/
		          "orange2_key1": [6,7,8,9,18,19,20,21],			/*F#/Gb Key cube*/
		          "orange2_key2": [18,19,20,21,30,31,32,33],		/*D#/Eb Key cube*/
		          "orange2_key3": [30,31,32,33,42,43,44,45],		/*C Key cube*/
		          "orange2_key4": [42,43,44,45,6,7,8,9],			/*A Key cube*/

		          "green2": [8,9,10,11,20,21,22,23,32,33,34,35,44,45,46,47], /*green hypercube 2, tonic alpha is in atrium 2*/
		          "green2_key1": [8,9,10,11,20,21,22,23],		/*G#/Ab Key cube*/
		          "green2_key2": [20,21,22,23,32,33,34,35],		/*F Key cube*/
		          "green2_key3": [32,33,34,35,44,45,46,47],		/*D Key cube*/
		          "green2_key4": [44,45,46,47,8,9,10,11],		/*B Key cube*/

		          "purple2": [10,11,12,13,22,23,24,25,34,35,36,37,46,47,0,1],  /*purple hypercube 2, tonic alpha is in atrium 2*/
		          "purple2_key1": [10,11,12,13,22,23,24,25],		/*A#/Bb Key cube*/
		          "purple2_key2": [22,23,24,25,34,35,36,37],		/*G Key cube*/
		          "purple2_key3": [34,35,36,37,46,47,0,1],		/*E Key cube*/
		          "purple2_key4": [46,47,0,1,10,11,12,13]		/*C#/Db Key cube*/
					},

          /* 2D VIEWABLE */
          /* below is a list of 2D subsets that for now I will just classify (not sure if they should be ‘viewable subsets’ or not)*/

          /* KEYSTONES */
          /*can split into four groups, one for each fifth cycle*/
          keystones: {
            "1": [0,1,2,3],		/*C*/
            "2": [2,3,4,5],	 /*D*/
            "3": [4,5,6,7],		/*E*/
            "4": [6,7,8,9],		/*F#/Gb*/
            "5": [8,9,10,11],	/*G#/Ab*/
            "6": [10,11,12,13],	/*A#/Bb*/
            "7": [12,13,14,15], /*A*/
            "8": [14,15,16,17], /*B*/
            "9": [16,17,18,19],	/*C#/Db*/
            "10": [18,19,20,21],	/*D#/Eb*/
            "11": [20,21,22,23],	/*F*/
            "12": [22,23,24,25],	/*G*/
            "13": [24,25,26,27],	/*F#/Gb*/
            "14": [26,27,28,29],	/*G#/Ab*/
            "15": [28,29,30,31],	/*A#/Bb*/
            "16": [30,31,32,33],	/*C*/
            "17": [32,33,34,35],	/*D*/
            "18": [34,35,36,37],	/*E*/
            "19": [36,37,38,39],	/*D#/Eb*/
            "20": [38,39,40,41],	/*F*/
            "21": [40,41,42,43],	/*G*/
            "22": [42,43,44,45],	/*A*/
            "23": [44,45,46,47],	/*B*/
            "24": [46,47,0,1]	    /*C#/Db*/
          },

          /*below: tonics and dominants 1 and 2 belong to hypercubes 1 and 2 respectively (ignoring plagal function for convenience)*/
          /*list is in order of tone column*/

          /*GREEN DOMINANT 2*/
          green_dominant_2: {
            "1": [0,1,12,13],		/*F6/Dm7*/
            "2": [12,13,24,25],		/*D6/Bm7*/
            "3": [24,25,36,37],		/*B6/(G#/Abm7)*/
            "4": [36,37,0,1]		/*(G#/Ab6)/Fm7*/
          },

          /*ORANGE TONICS 1*/
          orange_tonics_1: {
            "1": [1,2,13,14], 		/*C6/ Am7*/
            "2": [13,14,25,26],		/*A6/(F#/Gbm7)*/
            "3": [25,26,37,38],	/*(F#/Gb6)/(D#/Ebm7)*/
            "4": [37,38,1,2]		/*(D#/Eb6)/Cm7*/
          },

          /*PURPLE DOMINANT 1*/
          purple_dominant_1: {
            "1": [2,3,14,15],		/*G6/Em7*/
            "2": [14,15,26,27],		/*E6/(C#/Dbm7)*/
            "3": [26,27,38,39],		/*(C#/Db6)/(A#/Bbm7)*/
            "4": [38,39,2,3]		/*(A#/Bb6)/G6*/
          },

          /*GREEN TONICS 2*/
          green_tonics_2: {
            "1": [3,4,15,16],		/*D6/Bm7*/
            "2": [15,16,27,28],		/*B6/(G#/Abm7)*/
            "3": [27,28,39,40],		/*(G#/Ab6)/Fm7*/
            "4": [39,40,3,4]		/*F6/Dm7*/
          },

          /*ORANGE DOMINANT 2*/
          orange_dominant_2: {
            "1": [4,5,16,17],		/*A6/(F#/Gbm7)*/
            "2": [16,17,28,29],		/*(F#/Gb6)/(D#/Ebm7)*/
            "3": [28,29,40,41],		/*(D#/Eb6)/Cm7*/
            "4": [40,41,4,5]		/*C6/ Am7*/
          },

          /*PURPLE TONICS 1*/
          purple_tonics_1: {
            "1": [5,6,17,18],		/*E6/(C#/Dbm7)*/
            "2": [17,18,29,30],		/*(C#/Dbm7)/(A#/Bbm7)*/
            "3": [29,30,41,42],		/*(A#/Bb6)/Gm7*/
            "4": [41,42,5,6]		/*G6/Em7*/
          },

          /*GREEN DOMINANT 1*/
          green_dominant_1: {
            "1": [6,7,18,19],		/*B6/(G#/Abm7)*/
            "2": [18,19,30,31],	/*(G#/Ab6)/Fm7*/
            "3": [30,31,42,43],		/*F6/Dm7*/
            "4": [42,43,6,7]		/*D6/Bm7*/
          },

          /*ORANGE TONICS 2*/
          orange_tonics_2: {
            "1": [7,8,19,20],		/*(F#/Gb6)/(D#/Ebm7)*/
            "2": [19,20,31,32],		/*(D#/Eb6)/Cm7*/
            "3": [31,32,43,44],		/*C6/ Am7*/
            "4": [43,44,7,8]		/*A6/(F#/Gbm7)*/
          },

          /*PURPLE DOMINANT 2*/
          purple_dominant_2: {
            "1": [8,9,20,21],		/*(C#/Db6)/(A#/Bbm7)*/
            "2": [20,21,32,33],		/*(A#/Bb6)/G6*/
            "3": [32,33,44,45],		/*G6/Em7*/
            "4": [44,45,8,9]		/*E6/(C#/Dbm7)*/
          },

          /*GREEN TONICS 1*/
          green_tonics_1: {
            "1": [9,10,21,22],		/*(G#/Ab6)/Fm7*/
            "2": [21,22,33,34],		/*F6/Dm7*/
            "3": [33,34,45,46],		/*D6/Bm7*/
            "4": [45,46,9,10]		/*B6/(G#/Abm7)*/
          },

          /*ORANGE DOMINANT 1*/
          orange_dominant_1: {
            "1": [10,11,22,23],		/*(D#/Eb6)/Cm7*/
            "2": [22,23,34,35], 		/*C6/ Am7*/
            "3": [34,35,46,47],		/*A6/(F#/Gbm7)*/
            "4": [46,47,10,11]		/*(F#/Gb6)/(D#/Ebm7)*/
          },

          /*PURPLE TONICS 2*/
          purple_tonics_2: {
            "1": [11,0,23,12],		/*(A#/Bb6)/Gm7*/
            "2": [23,12,35,24],		/*G6/Em7*/
            "3": [35,24,47,36],		/*E6/(C#/Dbm7)*/
            "4": [47,36,11,0]		/*(C#/Dbm7)/(A#/Bbm7)*/
          },

          /*below: diminished triads 1 and 2 belong to atria 1 and 2 respectively (which, conversely, means that they belong to hypercubes 2 and 1 respectively)*/
          /*list is in order of tone column*/

          /*BLUE DIMINISHED TRAIDS 2*/
          blue_diminished_triads_2: {
            "1": [0,3,12,15],		/*B*/
            "2": [12,15, 24,27],		/*G#/Ab*/
            "3": [24,27, 36,39],		/*F*/
            "4": [36,39,0,3]		/*D*/
          },

          /*RED DIMINISHED TRAIDS 1*/
          red_diminished_triads_1: {
            "1": [2,5,14,17],		/*C#/Db*/
            "2": [14,17,26,29],		/*A#/Bb*/
            "3": [26,29,38,41],		/*G*/
            "4": [38,41,2,5]		/*E*/
          },

          /*YELLOW DIMINISHED TRAIDS 2*/
          yellow_diminished_triads_2: {
            "1": [4,7,16,19],		/*D#/Eb*/
            "2": [16,19,28,31],		/*C*/
            "3": [28,31,40,43],		/*A*/
            "4": [40,43,4,7]		/*D#/Eb*/
          },

          /*BLUE DIMINISHED TRAIDS 1*/
          blue_diminished_triads_1: {
            "1": [6,9,18,21],	/*F*/
            "2": [18,21,30,33],		/*D*/
            "3": [30,33,42,45],		/*B*/
            "4": [42,45,6,9]		/*G#/Ab*/
          },

          /*RED DIMINISHED TRAIDS 2*/
          red_diminished_triads_2: {
            "1": [8,11,20,23],		/*G*/
            "2": [20,23,32,35],		/*E*/
            "3": [32,35,44,47],		/*C#/Db*/
            "4": [44,47,8,11]		/*A#/Bb*/
          },

          /*YELLOW DIMINISHED TRAIDS 1*/
          yellow_diminished_triads_1: {
            "1": [10,1,22,13],		/*A*/
            "2": [22,13,34,25],		/*D#/Eb*/
            "3": [34,25, 46,37],		/*D#/Eb*/
            "4": [46,37,10,1]		/*C*/
          }
        },

        projection: function(c) {
          // 5D to 3D
					var h = 4;
          return [4*c[0]/(4-c[4]), 4*c[1]/(4-c[4]), 4*c[3]/(4-c[4])]
        },

        viewingSet: [],

				setViewingSet: function(s) {
					this.viewingSet = s;
				},

        initialize: function() {
          // stores current note in the vertex
          this.vertices = {};  // this.vertices[index] = [[x,y,z,v,w], current_note_name]
          // stores current position of a note
          this.note_position = {};
          // stores coordinates of given vertex index
          this.coordinates = {};

          for (var note in this.initial_notes) {
            var coors = this.initial_notes[note].slice(0, 5);
            var index = this.initial_notes[note][7];

            this.coordinates[index] = coors;
            this.vertices[index] = [coors, note];
            this.note_position[note] = index;
          }

					this.edge_set = {};
					for (var i = 0; i < this.edges.length; i++) {
						this.edge_set[this.edges[i][0] + ";" + this.edges[i][1]] = true;
					}
        },

        edge_color: function(color1, color2) {
          if ((color1 == yellow && color2 == red) || (color2 == yellow && color1 == red)) {
            return orange;
          }
          if ((color1 == yellow && color2 == blue) || (color2 == yellow && color1 == blue)) {
            return green;
          }
          if ((color1 == blue && color2 == red) || (color2 == blue && color1 == red)) {
            return purple;
          }
          return color1;
        },

        render: function() { // renders current viewing set
          var note_names = [];

          for (var i = 0; i < this.viewingSet.length; i++) {
            var index = this.viewingSet[i];
            var cs = this.projection(this.vertices[index][0]);
            var name = this.vertices[index][1];
            var clr = this.initial_notes[name][5];
            note_names.push(name);

            addVertex(new THREE.Vector3(cs[0], cs[1], cs[2]), name, clr);
          }

					for (var i = 0; i < note_names.length; i++) {
						for (var j = i + 1; j < note_names.length; j++) {
							if (((note_names[i] + ";" + note_names[j]) in this.edge_set) || ((note_names[j] + ";" + note_names[i]) in this.edge_set)) {

								var from = this.note_position[note_names[i]];
	              var to = this.note_position[note_names[j]];

	              var cfrom = this.projection(this.vertices[from][0]);
	              var cto = this.projection(this.vertices[to][0]);

	              addEdge(new THREE.Vector3(cfrom[0], cfrom[1], cfrom[2]), new THREE.Vector3(cto[0], cto[1], cto[2]),
	                this.edge_color(this.initial_notes[note_names[i]][5], this.initial_notes[note_names[j]][5]));
							}
						}
					}

        },

        make_transition: function(permutation) {
          transition = true;
          step = 0;
          transition_permutation = permutation;
        },

        transition_render: function() {
          var t = step/transition_steps;

					////////////
          var note_names = [];

          for (var i = 0; i < this.viewingSet.length; i++) {
            var index = this.viewingSet[i];
            var cs = this.projection(this.vertices[index][0]);
            if (index in transition_permutation) {
              var cs_dest = this.projection(this.vertices[transition_permutation[index]][0]);
              cs = [(1-t)*cs[0] + t*cs_dest[0], (1-t)*cs[1] + t*cs_dest[1], (1-t)*cs[2] + t*cs_dest[2]]
            }
            var name = this.vertices[index][1];
            var clr = this.initial_notes[name][5];
            note_names.push(name);
            addVertex(new THREE.Vector3(cs[0], cs[1], cs[2]), name, clr);
          }


					for (var i = 0; i < note_names.length; i++) {
						for (var j = i + 1; j < note_names.length; j++) {
							if (((note_names[i] + ";" + note_names[j]) in this.edge_set) || ((note_names[j] + ";" + note_names[i]) in this.edge_set)) {
								var from = this.note_position[note_names[i]];
								var to = this.note_position[note_names[j]];

								var cfrom = this.projection(this.vertices[from][0]);
								if (from in transition_permutation) {
	                var cs_dest = this.projection(this.vertices[transition_permutation[from]][0]);
	                cfrom = [(1-t)*cfrom[0] + t*cs_dest[0], (1-t)*cfrom[1] + t*cs_dest[1], (1-t)*cfrom[2] + t*cs_dest[2]]
	              }
								var cto = this.projection(this.vertices[to][0]);
								var cto = this.projection(this.vertices[to][0]);
								if (to in transition_permutation) {
									var cs_dest = this.projection(this.vertices[transition_permutation[to]][0]);
									cto = [(1-t)*cto[0] + t*cs_dest[0], (1-t)*cto[1] + t*cs_dest[1], (1-t)*cto[2] + t*cs_dest[2]]
								}
								if (cfrom[0] != cto[0] || cfrom[1] != cto[1] || cfrom[2] != cto[2]) {
									addEdge(new THREE.Vector3(cfrom[0], cfrom[1], cfrom[2]), new THREE.Vector3(cto[0], cto[1], cto[2]),
										this.edge_color(this.initial_notes[note_names[i]][5], this.initial_notes[note_names[j]][5]));
								}
							}
						}
					}

          if (step == transition_steps) {
            // update this.vertices, this.note_position
            var new_note_position = {};
            for (var note in this.note_position) {
              if (this.note_position[note] in transition_permutation) {
                new_note_position[note] = transition_permutation[this.note_position[note]];
              }
              else {
                new_note_position[note] = this.note_position[note];
              }
            }
            var new_vertices = {};
            for (var note in new_note_position) {
              new_vertices[new_note_position[note]] = [this.coordinates[new_note_position[note]], note];
            }
            this.note_position = new_note_position;
            this.vertices = new_vertices;


            transition = false;
            step = 0;
            transition_permutation = {};

            clearScene();
            this.render();
          }
        }
      };

      /**********************************************************
        TRANSITION variable - to avoid needless rendering
      **********************************************************/
      var transition_steps = 22;
      var transition = false;
      var step = 0;
      var transition_permutation = {};

      /***********************
        The main loop - continuous animation
      ************************/
      METAPRISM.initialize();
			METAPRISM.setViewingSet(METAPRISM.subsets.hypercubes.orange1);
      METAPRISM.render();
			METAPRISM.make_transition({0:24,1:25,2:26,3:27,12:36,13:37,14:38,15:39, 24:0,25:1,26:2,27:3,36:12,37:13,38:14,39:15 });

      var one_more = false;

      var animate = function () {
        if (transition) {
          clearScene();
          METAPRISM.transition_render();
          step += 1;
        }

				requestAnimationFrame( animate );
				renderer.render( scene, camera );
				labelRenderer.render( scene, camera );
			};
			animate();


		</script>
	</body>
</html>
