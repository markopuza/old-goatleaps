<html>
	<head>
		<title> Metaharmony </title>
		<style>
      body {
      				background-color: #000;
      				margin: 0;
      				overflow: hidden;
      			}

			canvas { width: 100%; height: 100% }

      .label{
				color: #000000;
				font-family: sans-serif;
				font-size: 1.7em;
				margin-left: 0.7em;
				padding: 0.7em;
			}

			.label{
				color: #000000;
				font-family: sans-serif;
			}
		</style>
	</head>
	<body>
		<script src="script/three.min.js"></script>
		<script src="script/dat.gui.min.js"></script>
    <script src="script/orbit_controls.js"></script>
    <script src="script/threejslabelrenderer.js"></script>
		<script>

			var enabled_controls = true;

	    var blue = 0x0066ff;
	    var purple = 0x9933ff;
	    var red = 0xcc0000;
	    var orange = 0xff9900;
	    var yellow = 0xffff00;
	    var green = 0x00cc00;

			var notes = [
				[1,1,1,  'A',yellow],
				[1,1,-1, 'D 0',blue],
				[1,-1,1, 'C',yellow],
				[-1,1,1, 'E',red],
				[-1,-1,1,'G',red],
				[-1,1,-1,'B',blue],
				[1,-1,-1,'F',blue],
				[-1,-1,-1,'D 1',blue]
			]

			var edges = [
				['A', 'C', yellow],
				['G', 'C', orange],
				['E', 'A', orange],
				['E', 'G', red],
				['A', 'D 0', green],
				['F', 'C', green],
				['D 1', 'G', purple],
				['B', 'E', purple],
				['B', 'D 0', blue],
				['B', 'D 1', blue],
				['F', 'D 0', blue],
				['F', 'D 1', blue]
			];

			// var notes = [
			// 	[0,1,2, 'E', red],
			// 	[Math.sqrt(3),1,1, 'A', yellow],
			// 	[Math.sqrt(3),1,-1, 'C', yellow],
			// 	[0,1,-2, 'F',blue],
			// 	[-Math.sqrt(3),1,-1,'Ab',blue],
			// 	[-Math.sqrt(3),1,1,'Db',red],
			//
			// 	[0,-1,2, 'G', red],
			// 	[Math.sqrt(3),-1,1, 'C 1', yellow],
			// 	[Math.sqrt(3),-1,-1, 'Eb', yellow],
			// 	[0,-1,-2, 'Ab 1',blue],
			// 	[-Math.sqrt(3),-1,-1,'B',blue],
			// 	[-Math.sqrt(3),-1,1,'E 1',red]
			// ]

			// var edges = [
			// 	['E', 'A', orange],
			// 	['G', 'C 1', orange],
			// 	['A', 'C', yellow],
			// 	['A', 'C 1', yellow],
			// 	['C', 'Eb', yellow],
			// 	['C 1', 'Eb', yellow],
			// 	['C', 'F', green],
			// 	['Eb', 'Ab 1', green],
			// 	['F', 'Ab', blue],
			// 	['F', 'Ab 1', blue],
			// 	['Ab 1', 'B', blue],
			// 	['Ab', 'B', blue],
			// 	['Ab', 'Db', purple],
			// 	['B', 'E 1', purple],
			// 	['Db', 'E', red],
			// 	['Db', 'E 1', red],
			// 	['E', 'G', red],
			// 	['E 1', 'G', red]
			// ];

			// var edges = [
			// 	['A', 'Db', orange],
			// 	['G', 'A', orange],
			// 	['G', 'Eb', orange],
			// 	['A', 'Eb', yellow],
			// 	['A', 'F', green],
			// 	['Eb', 'F', green],
			// 	['Eb', 'B', green],
			// 	['F', 'B', blue],
			// 	['F', 'Db', purple],
			// 	['Db', 'B', purple],
			// 	['B', 'G', purple],
			// 	['Db', 'G', red]
			// ];



			var axes = [
				[1,0,0,'x'],
				[0,1,0,'y'],
				[0,0,1,'z']
			]

			// represents the WHOLE THING
			var thing = new THREE.Group();


			function addNote(pos, name, color) {
				var geometry = new THREE.DodecahedronGeometry( 0.06 );
				var meshMaterial = new THREE.MeshBasicMaterial( {color: color} );
				var sphere = new THREE.Mesh( geometry, meshMaterial );
				sphere.position.set(pos.x, pos.y, pos.z);

				var noteDiv = document.createElement( 'div' );
				noteDiv.className = 'label';
				noteDiv.textContent = name.split(' ')[0];
				noteDiv.style.marginTop = '-25px';
				noteDiv.style.zIndex = 2;

				var noteLabel = new THREE.CSS2DObject( noteDiv );
				// noteLabel.position.set( pos.x, pos.y, pos.z );
				sphere.add( noteLabel );
				thing.add( sphere );
			}

			function addEdge(from, to, color) { // from, to are Vectors
				var vector = to.sub(from);
				var group = new THREE.Group();

				var geometry = new THREE.CylinderGeometry(0.06, 0.06, vector.length(), 12, 12);
				var meshMaterial = new THREE.MeshBasicMaterial( {color: color} );
				var lineMaterial = new THREE.LineBasicMaterial( { color: 0x222222, transparent: true, opacity: 0.1 } );

				var mesh = new THREE.Mesh(geometry, meshMaterial);
				var frame = new THREE.LineSegments( geometry, lineMaterial );

				var axis = new THREE.Vector3(0, 1, 0);
				mesh.quaternion.setFromUnitVectors(axis, vector.clone().normalize());
				// mesh.position.copy(vector.add(from).clone().multiplyScalar(0.5));
				frame.quaternion.setFromUnitVectors(axis, vector.clone().normalize());
				// frame.position.copy(vector.add(from).clone().multiplyScalar(0.5));

				var edgeCenter = from.add(vector.multiplyScalar(0.5));
				mesh.position.set(edgeCenter.x, edgeCenter.y, edgeCenter.z);
				frame.position.set(edgeCenter.x, edgeCenter.y, edgeCenter.z);

				group.add(mesh);
				group.add(frame);

				thing.add( group );
			}

			var scene = new THREE.Scene();
      scene.background = new THREE.Color( 0xeeeeee );

			var camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 1000 );

			var renderer = new THREE.WebGLRenderer();
			renderer.setSize( window.innerWidth, window.innerHeight );
			document.body.appendChild( renderer.domElement );

      var labelRenderer = new THREE.CSS2DRenderer();
        labelRenderer.setSize( window.innerWidth, window.innerHeight );
        labelRenderer.domElement.style.position = 'absolute';
        labelRenderer.domElement.style.top = 0;
        document.body.appendChild( labelRenderer.domElement );

			if (enabled_controls) {
				var controls = new THREE.OrbitControls( camera );
			}


			var note_dict = {};

			for (i = 0; i < notes.length; i++) {
				var n = notes[i];
				addNote(new THREE.Vector3(n[0], n[1], n[2]), n[3], n[4]);
				note_dict[n[3]] = [n[0], n[1], n[2], n[4]];
			}

			for (i = 0; i < edges.length; i++) {
				var e = edges[i];
				var from = note_dict[e[0]]; var to = note_dict[e[1]];
				addEdge(new THREE.Vector3(from[0], from[1], from[2]), new THREE.Vector3(to[0], to[1], to[2]), e[2]);
			}

			/////////////////////////////////////
			// add axes
			/////////////////////////////////////
			var axes_pointers = {};
			for (i = 0; i < axes.length; i++) {
				var a = axes[i];
				var ax_material = new THREE.LineBasicMaterial({color: 0x000000});
				var geometry = new THREE.Geometry();
				geometry.vertices.push(new THREE.Vector3(0,0,0), new THREE.Vector3(a[0],a[1],a[2]));
				var line = new THREE.Line( geometry, ax_material );

				var geometry = new THREE.SphereGeometry( 0.01 );
				var meshMaterial = new THREE.MeshBasicMaterial( {color: 0x000000} );
				var sphere = new THREE.Mesh( geometry, meshMaterial );
				sphere.position.set(a[0],a[1],a[2]);

				var noteDiv = document.createElement( 'div' );
				noteDiv.className = 'axis';
				noteDiv.textContent = a[3];
				noteDiv.style.marginTop = '-10px';
				noteDiv.style.zIndex = 2;
				var noteLabel = new THREE.CSS2DObject( noteDiv );
				sphere.add( noteLabel );
				thing.add( line );
				axes_pointers[a[3]] = sphere;
				thing.add( sphere );
			}
			/////////////////////////////////////
			/////////////////////////////////////

			scene.updateMatrixWorld(true);
			scene.add( thing );

      thing.rotation.y = 0.4;
			thing.rotation.x = 0.1;

			camera.position.z = 4;

      renderer.render( scene, camera );
      labelRenderer.render( scene, camera );


			/// rotations

			//////////////////////////////////
			//////////////////////////////////

			var rotationVector = new THREE.Vector3(0, 0, 1);
			var rotationStep = Math.PI/200;
			var rotation_rep = 0;

			var animate = function () {
				requestAnimationFrame( animate );

				///// ROTATION
				if (rotation_rep > 0) {
					rotation_rep -= 1;
					thing.rotateOnAxis(rotationVector.normalize(), rotationStep);

					// thing.rotateX(dx);
					// thing.rotateY(dy);
					// thing.rotateZ(dz);
				}
				// else {
				// 	var t = dx;
				// 	dx = dy;
				// 	dy = t;
				// 	rotation_rep = 100;
				// }
				//////////////////

				renderer.render( scene, camera );
        labelRenderer.render( scene, camera );
			};

			animate();

			/////////////////////////////////////
			// gui
			// Functional rotations: 90; y
			// Relative rotations: 180; z
			////////////////////////
			var gui = new dat.GUI();
			var f0 = gui.addFolder('Current note');
			var f1 = gui.addFolder('Functional rotation');
			var f2 = gui.addFolder('Relative rotation');

			var CurrentNoteControls = function() {
					this.note = 'C';
				};
			var cnc = new CurrentNoteControls();
			f0.add(cnc, 'note').name('Current note');

			var FunctionalControls = function() {
					this.clockwise = function() {
						if (rotation_rep == 0) {
						rotationVector = new THREE.Vector3(0, 1, 0); // y
						rotationStep = -Math.PI/200;
						rotation_rep = 100; }
					 };
				  this.anticlockwise = function() {
						if (rotation_rep == 0) {
						rotationVector = new THREE.Vector3(0, 1, 0); // y
						rotationStep = Math.PI/200;
						rotation_rep = 100; }
					 };
				};
			var fc = new FunctionalControls();
			f1.add(fc, 'clockwise').name('Rotate CW');
			f1.add(fc, 'anticlockwise').name('Rotate CCW');

			var RelativeControls = function() {
					this.clockwise = function() {
						if (rotation_rep == 0) {
						rotationVector = new THREE.Vector3(0, 0, 1); // z
						rotationStep = -Math.PI/200;
						rotation_rep = 200; }
					 };
				  this.anticlockwise = function() {
						if (rotation_rep == 0) {
						rotationVector = new THREE.Vector3(0, 0, 1); // z
						rotationStep = Math.PI/200;
						rotation_rep = 200; }
					 };
				};
			var rc = new RelativeControls();
			f2.add(rc, 'clockwise').name('Rotate CW');
			f2.add(rc, 'anticlockwise').name('Rotate CCW');

			f0.open();
			f1.open();
			f2.open();

		
		</script>
	</body>
</html>
